# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Python tool that uploads Markdown files to Notion, converting various Markdown elements into Notion blocks. It supports frontmatter, images, math equations, code blocks, Obsidian-style callouts, and has special handling for `remote-claude` generated files.

## Development Commands

### Installation
```bash
pip install -r requirements.txt
```

### Running the Application
```bash
# Basic usage with main.py
python main.py your_markdown_file.md

# With verbose logging
python main.py -v your_markdown_file.md

# Using CLI interface
python cli.py your_markdown_file.md
mdupload your_markdown_file.md  # if installed via setup.py
```

### Development Tools
```bash
# Install development dependencies
pip install -e ".[dev]"

# Run tests
pytest

# Code formatting and linting
black .
flake8 .
mypy src/
```

## Architecture

The application follows a modular architecture with clear separation of concerns:

- **main.py**: Entry point for direct script execution
- **cli.py**: Command-line interface with additional features like dry-run mode
- **src/config.py**: Configuration management using dataclasses, loads from ~/.token/notion/ files
- **src/uploader.py**: Main orchestrator that coordinates all components
- **src/markdown_parser.py**: Parses Markdown and frontmatter, handles Obsidian callouts
- **src/notion_block_converter.py**: Converts parsed Markdown to Notion API blocks
- **src/notion_client.py**: Notion API client wrapper with error handling and fallbacks
- **src/image_uploader.py**: Handles image uploads to FTP or ImgBB services

### Key Design Patterns

1. **Configuration Management**: Uses dataclass-based Config that loads from both files and environment variables
2. **Error Handling**: Comprehensive error handling with fallback mechanisms (e.g., callout blocks fall back to quote blocks)
3. **Special Format Detection**: Automatically detects and processes `remote-claude` format files differently
4. **Block Processing**: Converts Markdown to intermediate representation before Notion API blocks

## Configuration Files

The application requires configuration files in `~/.token/notion/`:
- `.terminal_memo_id`: Notion database ID
- `.terminal_memo_token`: Notion API token

Optional environment variables:
- `FTP_USER`, `FTP_PASS`: For FTP image uploads
- `IMGBB_API_KEY`: For ImgBB image uploads

## Special Features

### Remote-Claude Format Support
The application detects files generated by `remote-claude` function and applies special processing:
- Extracts execution metadata (timestamp, connection, prompt file)
- Converts prompts to visually distinct callout blocks
- Organizes content with proper sectioning and emojis

### Obsidian Callouts
Supports Obsidian-style callouts (`> [!NOTE]`, `> [!WARNING]`, etc.) with automatic emoji mapping and conversion to Notion callout blocks (with quote block fallback).

### Image Handling
Images are automatically uploaded to configured services (FTP or ImgBB) and referenced in Notion blocks. Local image paths are resolved relative to the source Markdown file.

### Large File Handling
Automatically splits large files into multiple Notion pages due to the 100-block limit per page.

## Common Issues

1. **Notion API Limits**: The application respects Notion's 100 blocks per page limit
2. **Callout Block Compatibility**: Falls back to quote blocks if callout blocks aren't supported
3. **Image Upload Failures**: Uses placeholder images if upload services are unavailable
4. **File Encoding**: All files are read as UTF-8